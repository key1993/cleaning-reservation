    <!DOCTYPE html>
    <html>
    <head>
      <title>Admin - Dashboard</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          padding: 20px;
        }
        .logo-container {
          text-align: center;
          margin-bottom: 10px;
        }
        .logo-container img {
          height: 130px;
        }
        h1 {
          text-align: center;
          margin-top: 10px;
        }
        .tab-buttons {
          display: flex;
          justify-content: center;
          margin-bottom: 10px;
        }
        .tab-buttons button {
          margin: 0 10px;
          padding: 10px 20px;
          cursor: pointer;
          font-size: 16px;
        }
        .tab-content {
          display: none;
        }
        .tab-content.active {
          display: block;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }
        th, td {
          border: 1px solid #aaa;
          padding: 8px;
          text-align: left;
        }
        th {
          background-color: #f2f2f2;
        }
        .id-cell {
          font-family: monospace;
          font-size: 0.9em;
          color: #555;
        }
        .inline-form {
          display: inline-block;
          margin-right: 5px;
        }
        .cost-input {
          width: 80px;
        }
        .status-label {
          font-weight: bold;
        }
        .status-pending { color: orange; }
        .status-confirmed { color: green; }
        .status-canceled { color: red; }
        .status-done { color: blue; }
        .payment-due {
          background-color: #fff3cd;
          border: 1px solid #ffeaa7;
        }
        .payment-overdue {
          background-color: #f8d7da;
          border: 1px solid #f5c6cb;
        }
        .payment-checkbox {
          transform: scale(1.5);
          margin: 0;
        }
        .modal {
          display: none;
          position: fixed;
          z-index: 1;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
          background-color: #fefefe;
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
          max-width: 500px;
          border-radius: 5px;
        }
        .modal-buttons {
          text-align: center;
          margin-top: 20px;
        }
        .modal-buttons button {
          margin: 0 10px;
          padding: 10px 20px;
          cursor: pointer;
        }
        .btn-confirm {
          background-color: #28a745;
          color: white;
          border: none;
          border-radius: 3px;
        }
        .btn-cancel {
          background-color: #6c757d;
          color: white;
          border: none;
          border-radius: 3px;
        }
      </style>
    </head>
    <body>

      <!-- Logo -->
      <div class="logo-container">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="EBSHER Logo">
      </div>

      <h1>Admin Panel</h1>

      <!-- Tabs -->
      <div class="tab-buttons">
        <button onclick="showTab('reservations')">Reservations</button>
        <button onclick="showTab('clients')">Clients</button>
      </div>

      <!-- Reservation Tab -->
      <div id="reservations" class="tab-content active">
        <h2>Cleaning Reservations</h2>
        <div style="margin-bottom: 10px;">
          <button onclick="deleteSelectedReservations()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">
            Delete Selected Reservations
          </button>
          <span id="selectedReservationsCount" style="margin-left: 10px; color: #666;"></span>
        </div>
        <table>
                                 <tr>
         <th>
              <input type="checkbox" id="selectAllReservations" onchange="toggleSelectAllReservations(this)">
            </th>
         <th>ID</th>
         <th>User ID</th>
         <th>Date</th>
         <th>Time Slot</th>
         <th>Location</th>
         <th>Panels</th>
         <th>Status</th>
         <th>Cost (JOD)</th>
         <th>Actions</th>
       </tr>
                {% for r in reservations %}
             <tr>
         <td>
              <input type="checkbox" class="reservation-checkbox" value="{{ r._id }}" onchange="updateSelectedReservationsCount()">
            </td>
         <td class="id-cell">{{ r._id }}</td>
         <td>{{ r.user_id }}</td>
         <td>{{ r.date }}</td>
            <td>{{ r.time_slot }}</td>
            <td>
              {% if r.latitude and r.longitude %}
                <a href="https://www.google.com/maps?q={{ r.latitude }},{{ r.longitude }}" target="_blank">
                  ({{ r.latitude }}, {{ r.longitude }})
                </a>
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ r.number_of_panels }}</td>
            <td>
              {% if r.status == 'Confirmed' %}
                <span class="status-label status-confirmed">Approved</span>
              {% elif r.status == 'Canceled' %}
                <span class="status-label status-canceled">Canceled</span>
              {% elif r.status == 'Done' %}
                <span class="status-label status-done">Done</span>
              {% else %}
                <span class="status-label status-pending">Pending</span>
              {% endif %}
            </td>
            <td>
              <form method="POST" action="/update_cost" class="inline-form">
                <input type="hidden" name="reservation_id" value="{{ r._id }}">
                <input type="number" name="cost" step="0.01" class="cost-input" value="{{ r.get('cost', '') }}">
                <button type="submit">Save</button>
              </form>
            </td>
            <td>
              {% if r.status == 'Pending' %}
                <form method="POST" action="/approve/{{ r._id }}" class="inline-form">
                  <button type="submit" style="color: green;">Approve</button>
                </form>
                <form method="POST" action="/deny/{{ r._id }}" class="inline-form">
                  <button type="submit" style="color: orange;">Deny</button>
                </form>
              {% endif %}
              <form method="POST" action="/delete/{{ r._id }}" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this reservation?');">
                <button type="submit" style="color: red;">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <!-- Clients Tab -->
      <div id="clients" class="tab-content">
        <h2>Registered Clients (Total: {{ clients|length }})</h2>
        <div style="margin-bottom: 10px;">
          <button onclick="deleteSelectedClients()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">
            Delete Selected Clients
          </button>
          <span id="selectedCount" style="margin-left: 10px; color: #666;"></span>
        </div>
        <table>
          <tr>
            <th>
              <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
            </th>
            <th>#</th>
            <th>Full Name</th>
            <th>Signup Date</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Subscription</th>
            <th>Next Payment</th>
            <th>Payment Due</th>
            <th>Location</th>
            <th>System Type</th>
            <th>HA URL</th>
            <th>HA Token</th>
            <th>Account Status</th>
            <th>Disable External Widget</th>
            <th>Actions</th>
          </tr>
          {% for c in clients %}
          <tr>
            <td>
              <input type="checkbox" class="client-checkbox" value="{{ c._id }}" onchange="updateSelectedCount()">
            </td>
            <td>{{ loop.index }}</td>
            <td>{{ c.full_name }}</td>
            <td>{{ c.signup_date }}</td>
            <td>{{ c.phone }}</td>
            <td>{{ c.email or 'N/A' }}</td>
            <td>
              <form method="POST" action="/update_subscription/{{ c._id }}" class="inline-form">
                <select name="subscription_type" onchange="this.form.submit()">
                  <option value="monthly" {% if c.subscription_type == 'monthly' %}selected{% endif %}>Monthly</option>
                  <option value="yearly" {% if c.subscription_type == 'yearly' %}selected{% endif %}>Yearly</option>
                </select>
              </form>
            </td>
            <td>{{ c.next_payment_date }}</td>
            <td>
              <input type="checkbox" class="payment-checkbox" onchange="confirmPayment('{{ c._id }}', '{{ c.full_name }}', '{{ c.subscription_type }}', this.checked)">
              <br><small>Confirm Payment</small>
            </td>
            <td>
              {% if c.location %}
                {% set parts = c.location.split(',') %}
                {% if parts | length == 2 %}
                  <a href="https://www.google.com/maps?q={{ parts[0] | trim }},{{ parts[1] | trim }}" target="_blank">
                    ({{ parts[0] | trim }}, {{ parts[1] | trim }})
                  </a>
                {% else %}
                  {{ c.location }}
                {% endif %}
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ c.system_type }}</td>
            <td>{{ c.ha_url }}</td>
            <td>{{ c.ha_token }}</td>
            <td>
              {% if c.firebase_uid %}
                {% if c.account_disabled %}
                  <span style="color: red; font-weight: bold;">üîí Disabled</span>
                  <br><small>Since: {{ c.account_disabled_date if c.account_disabled_date else 'N/A' }}</small>
                {% else %}
                  <span style="color: green; font-weight: bold;">‚úÖ Active</span>
                {% endif %}
                <br><small>UID: {{ c.firebase_uid[:8] }}...</small>
              {% else %}
                <span style="color: #666;">‚ö†Ô∏è No Firebase UID</span>
                <br><button onclick="searchFirebaseUser('{{ c._id }}', '{{ c.full_name }}')" style="background-color: #17a2b8; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; margin-top: 5px;">
                  Link by Email
                </button>
              {% endif %}
            </td>
            <td>
              <select class="widget-status-select" 
                      id="widget-select-{{ c._id }}"
                      data-previous-value="{% if c.get('external_widget_disabled') %}disabled{% else %}enabled{% endif %}"
                      onchange="toggleExternalWidget('{{ c._id }}', '{{ c.full_name }}', this.value, this)"
                      style="padding: 5px; font-size: 14px; border-radius: 3px; border: 1px solid #ccc; min-width: 120px;">
                <option value="enabled" {% if not c.get('external_widget_disabled') %}selected{% endif %}>Enabled</option>
                <option value="disabled" {% if c.get('external_widget_disabled') %}selected{% endif %}>Disabled</option>
              </select>
            </td>
            <td>
              <div style="display: flex; flex-direction: column; gap: 5px;">
                {% if c.firebase_uid %}
                  {% if c.account_disabled %}
                    <button onclick="enableAccount('{{ c._id }}', '{{ c.full_name }}')" style="background-color: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                      ‚úÖ Enable Account
                    </button>
                  {% else %}
                    <button onclick="disableAccount('{{ c._id }}', '{{ c.full_name }}')" style="background-color: #ffc107; color: #000; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                      üîí Disable Account
                    </button>
                  {% endif %}
                  <button onclick="deleteFirebaseAccount('{{ c._id }}', '{{ c.full_name }}')" style="background-color: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                    üóëÔ∏è Delete Firebase Account
                  </button>
                {% endif %}
                <form method="POST" action="/delete_client/{{ c._id }}" class="inline-form" onsubmit="return confirm('Delete this client?');">
                  <button type="submit" style="background-color: #6c757d; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; width: 100%;">
                    Delete Client
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <!-- Payment Confirmation Modal -->
      <div id="paymentModal" class="modal">
        <div class="modal-content">
          <h3>Confirm Payment</h3>
          <p id="modalMessage"></p>
          <div class="modal-buttons">
            <button class="btn-confirm" onclick="processPayment()">Yes, Confirm Payment</button>
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
          </div>
        </div>
      </div>

      <!-- JavaScript for Tabs and Payment -->
      <script>
        let currentPaymentData = null;

        function showTab(tabId) {
          document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
          });
          document.getElementById(tabId).classList.add('active');
        }

        function confirmPayment(clientId, clientName, subscriptionType, isChecked) {
          if (!isChecked) return;
          
          const subscriptionText = subscriptionType === 'monthly' ? 'monthly' : 'yearly';
          currentPaymentData = {
            clientId: clientId,
            clientName: clientName,
            subscriptionType: subscriptionType
          };
          
          document.getElementById('modalMessage').innerHTML = 
            `Are you sure that <strong>${clientName}</strong> has paid their ${subscriptionText} subscription?<br><br>
            This will update their next payment date automatically.`;
          
          document.getElementById('paymentModal').style.display = 'block';
        }

        function processPayment() {
          if (!currentPaymentData) return;
          
          fetch('/confirm_payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(currentPaymentData)
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Payment confirmed! Next payment date updated.');
              location.reload();
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error processing payment confirmation');
          });
          
          closeModal();
        }

        function closeModal() {
          document.getElementById('paymentModal').style.display = 'none';
          currentPaymentData = null;
          
          // Uncheck the checkbox
          const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
          checkboxes.forEach(cb => cb.checked = false);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
          const modal = document.getElementById('paymentModal');
          if (event.target == modal) {
            closeModal();
          }
        }

        // Bulk client deletion functions
        function toggleSelectAll(selectAllCheckbox) {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
          });
          updateSelectedCount();
        }

        function updateSelectedCount() {
          const checkedBoxes = document.querySelectorAll('.client-checkbox:checked');
          const count = checkedBoxes.length;
          const countSpan = document.getElementById('selectedCount');
          
          if (count > 0) {
            countSpan.textContent = `${count} client(s) selected`;
            countSpan.style.color = '#dc3545';
            countSpan.style.fontWeight = 'bold';
          } else {
            countSpan.textContent = '';
          }
          
          // Update select all checkbox state
          const allCheckboxes = document.querySelectorAll('.client-checkbox');
          const selectAllCheckbox = document.getElementById('selectAll');
          if (allCheckboxes.length > 0) {
            selectAllCheckbox.checked = checkedBoxes.length === allCheckboxes.length;
          }
        }

        function deleteSelectedClients() {
          const checkedBoxes = document.querySelectorAll('.client-checkbox:checked');
          
          if (checkedBoxes.length === 0) {
            alert('Please select at least one client to delete.');
            return;
          }
          
          const clientIds = Array.from(checkedBoxes).map(cb => cb.value);
          const count = clientIds.length;
          
          if (!confirm(`Are you sure you want to delete ${count} selected client(s)? This action cannot be undone.`)) {
            return;
          }
          
          // Send bulk delete request
          fetch('/delete_clients_bulk', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ client_ids: clientIds })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting clients');
          });
        }

        // Bulk reservation deletion functions
        function toggleSelectAllReservations(selectAllCheckbox) {
          const checkboxes = document.querySelectorAll('.reservation-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
          });
          updateSelectedReservationsCount();
        }

        function updateSelectedReservationsCount() {
          const checkedBoxes = document.querySelectorAll('.reservation-checkbox:checked');
          const count = checkedBoxes.length;
          const countSpan = document.getElementById('selectedReservationsCount');
          
          if (count > 0) {
            countSpan.textContent = `${count} reservation(s) selected`;
            countSpan.style.color = '#dc3545';
            countSpan.style.fontWeight = 'bold';
          } else {
            countSpan.textContent = '';
          }
          
          // Update select all checkbox state
          const allCheckboxes = document.querySelectorAll('.reservation-checkbox');
          const selectAllCheckbox = document.getElementById('selectAllReservations');
          if (allCheckboxes.length > 0) {
            selectAllCheckbox.checked = checkedBoxes.length === allCheckboxes.length;
          }
        }

        function deleteSelectedReservations() {
          const checkedBoxes = document.querySelectorAll('.reservation-checkbox:checked');
          
          if (checkedBoxes.length === 0) {
            alert('Please select at least one reservation to delete.');
            return;
          }
          
          const reservationIds = Array.from(checkedBoxes).map(cb => cb.value);
          const count = reservationIds.length;
          
          if (!confirm(`Are you sure you want to delete ${count} selected reservation(s)? This action cannot be undone.`)) {
            return;
          }
          
          // Send bulk delete request
          fetch('/delete_reservations_bulk', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reservation_ids: reservationIds })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting reservations');
          });
        }

        // Firebase account management functions
        function disableAccount(clientId, clientName) {
          if (!confirm(`Are you sure you want to disable the Firebase account for ${clientName}?`)) {
            return;
          }
          
          fetch(`/disable_client_account/${clientId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error disabling account');
          });
        }

        function enableAccount(clientId, clientName) {
          if (!confirm(`Are you sure you want to enable the Firebase account for ${clientName}?`)) {
            return;
          }
          
          fetch(`/enable_client_account/${clientId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error enabling account');
          });
        }

        function deleteFirebaseAccount(clientId, clientName) {
          if (!confirm(`‚ö†Ô∏è WARNING: This will permanently delete the Firebase account for ${clientName}!\n\nThis action cannot be undone. Are you absolutely sure?`)) {
            return;
          }
          
          fetch(`/delete_client_firebase_account/${clientId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting Firebase account');
          });
        }

        function searchFirebaseUser(clientId, clientName) {
          const email = prompt(`Enter the email address for ${clientName} to search in Firebase:`);
          
          if (!email) {
            return;
          }
          
          if (!confirm(`Search for Firebase user with email: ${email} and link to ${clientName}?`)) {
            return;
          }
          
          fetch('/search_firebase_user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: email,
              client_id: clientId
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(`‚úÖ Firebase user found!\n\nEmail: ${data.email}\nUID: ${data.firebase_uid}\nStatus: ${data.disabled ? 'Disabled' : 'Active'}\n\nAccount linked successfully!`);
              location.reload();
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error searching for Firebase user');
          });
        }

        function toggleExternalWidget(clientId, clientName, status, selectElement) {
          const isDisabled = status === 'disabled';
          const action = isDisabled ? 'disable' : 'enable';
          const previousValue = selectElement.getAttribute('data-previous-value') || (isDisabled ? 'enabled' : 'disabled');
          
          if (!confirm(`Are you sure you want to ${action} the external widget for ${clientName}?`)) {
            // Revert dropdown to previous value
            selectElement.value = previousValue;
            return;
          }
          
          // Store current value as previous value
          selectElement.setAttribute('data-previous-value', status);
          
          fetch(`/toggle_external_widget/${clientId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              disabled: isDisabled,
              client_name: clientName
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message);
              location.reload();
            } else {
              alert('Error: ' + data.error);
              // Revert dropdown to previous value on error
              selectElement.value = previousValue;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error toggling external widget');
            // Revert dropdown to previous value on error
            selectElement.value = previousValue;
          });
        }

      </script>
    </body>
    </html>
